# Скрипт для разбора логов

### Используемые модули и библиотеки

* Основной код написан на Python3
* В качестве базы данных для хранения результатов парсинга используется SQLite
* Запросы в БД пишутся не напрямую, а с использованием ORM [peewee](http://docs.peewee-orm.com/en/latest/peewee/quickstart.html)
* Для отображения прогресс-бара во время парсинга логов используется модуль [progressbar](https://github.com/niltonvolpato/python-progressbar)

### Установка нужных модулей в систему

Чтобы иметь возможность запускать основные скрипты, требуется доустановить в систему `peewee` и `progressbar`.

```bash
pip install peewee
pip install progressbar
```

### Принцип работы

Сначала в консоли нужно запусктить скрипт step1_parser.py. Он парсит файл с логами в БД.
```bash
python3 step1_parser.py
``` 

По окончании работы нужно выполнить следующий скрипт. Он выполняет аналитические запросы к сформированной БД. Результат выполнения выводится в консоль.

```bash
python3 main.py
```

### Скруктура кода и зоны ответственности

#### Папка `databases`

Cодержит файлы с БД SQLite, созданные на основании файла логов. Базы данных не полные. Из-за большого размера файла с логами это долгий процесс, поэтому на данном этапе в БД импортировано только 86998 поисковых запроса. В папке два файла. `initial.db` - основной, и резервный `initial_backup.db`. Его содержимое такое же, как у основного.

#### Папка `logs`

В папке `logs` лежат файлы с логами, которые подаются на обработку скриптам. Там должен лежать файл `football.dms` от Яндекса. Но он слишком большой. Вместо этого я создал файл `test.dms`. В нем небольшой кусок логов из файла `football.dms` для демонстрации работы.

#### Файл `models.py`

В файле `models.py` хранятся модели данных. На базе строк из лога по этим моделям создаются объекты поискового запроса и поискового контекста, которыми удобно манипулировать при записи в базу и осуществлении запросов в ней.

#### Файл `step1_parser.py` 
Сначала оценивает общее количество строк в файле логов для того, чтобы отображать в консоли прогресс-бар выполнения скрипта

Построчно читает лог. Каждую строчку из файла он сначала разбивает на 3 части:

* текст запроса - в виде списка из слов, составляющих запрос
* дата запроса
* время запроса

Затем для каждого слова из текста запроса создается свой уникальный идентификатор контекста, по которому впоследсивии 
можно будет восстановить весь запрос целиком. И далее каждое слово из запроса сохраняется в виде отдельной строки в БД
в таблице `searchrequest` 

Файл с логами парсится в БД database/initial.db. 

### Осуществление запросов к БД с целью аналитики

Достаточно мелкое разбиение поисковых запросов на отдельные слова и временные метки позволит нам писать запросы к БД,
которые позволят ответить на множество самых разнообразных вопросов. В качестве примера в файле `main.py` приведены
4 запроса к БД, проливающие свет на вопросы:

* В день матча Испания - Португалия за какую страну болели больше?
* Сколько запросов со словом "билет" было в день матча Испания-Португалия?
* Сколько людей хотели купить билет в день матча "Испания-Португалия"?
